<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุธุงู ูุชุงุจุนุฉ ุงูุทูุงุจ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#F3F4F6'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        .timer-active {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .student-card {
            transition: all 0.3s ease;
        }
        
        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .dark .student-card:hover {
            box-shadow: 0 8px 25px rgba(255,255,255,0.1);
        }
        
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
    </style>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#5D5CDE">
<link rel="icon" sizes="192x192" href="icons/icon-192.png">
<link rel="apple-touch-icon" href="icons/icon-192.png">
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white transition-colors duration-300">
    <!-- Header -->
    <div class="bg-primary text-white p-4 shadow-lg">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <h1 class="text-lg sm:text-xl md:text-2xl font-bold truncate">
                <i class="fas fa-school mr-2"></i>
                ูุธุงู ูุชุงุจุนุฉ ุงูุทูุงุจ
            </h1>
            <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 sm:space-x-reverse w-full sm:w-auto">
                <div id="currentTime" class="text-base sm:text-lg font-mono"></div>
                <button id="addStudentBtn" class="w-full sm:w-auto bg-white text-primary px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-base whitespace-nowrap">
                    <i class="fas fa-plus mr-1"></i>
                    ุฅุถุงูุฉ ุทุงูุจ
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Summary -->
    <div class="p-4 bg-gray-50 dark:bg-gray-800">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow text-center">
                <div class="text-2xl font-bold text-green-600" id="studentsInside">0</div>
                <div class="text-sm text-gray-600 dark:text-gray-300">ุฏุงุฎู ุงููุตู</div>
            </div>
            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow text-center">
                <div class="text-2xl font-bold text-red-600" id="studentsOutside">0</div>
                <div class="text-sm text-gray-600 dark:text-gray-300">ุฎุงุฑุฌ ุงููุตู</div>
            </div>
            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow text-center">
                <div class="text-2xl font-bold text-blue-600" id="totalStudents">0</div>
                <div class="text-sm text-gray-600 dark:text-gray-300">ุฅุฌูุงูู ุงูุทูุงุจ</div>
            </div>
            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow text-center">
                <div class="text-2xl font-bold text-orange-600" id="todayExits">0</div>
                <div class="text-sm text-gray-600 dark:text-gray-300">ุฎุฑูุฌ ุงูููู</div>
            </div>
        </div>
    </div>

    <!-- Students List -->
    <div class="p-4 overflow-hidden">
        <div class="mb-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <h2 class="text-xl font-bold whitespace-nowrap">ูุงุฆูุฉ ุงูุทูุงุจ</h2>
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 w-full sm:w-auto">
                <input type="text" id="searchInput" placeholder="ุงูุจุญุซ ุนู ุทุงูุจ..." 
                       class="w-full sm:w-48 px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base">
                <select id="filterStatus" class="w-full sm:w-auto px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base">
                    <option value="all">ุฌููุน ุงูุทูุงุจ</option>
                    <option value="inside">ุฏุงุฎู ุงููุตู</option>
                    <option value="outside">ุฎุงุฑุฌ ุงููุตู</option>
                </select>
            </div>
        </div>
        
        <div id="studentsList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
            <!-- Students will be loaded here -->
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4">ุฅุถุงูุฉ ุทุงูุจ ุฌุฏูุฏ</h3>
            <form id="addStudentForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ุงุณู ุงูุทุงูุจ</label>
                    <input type="text" id="studentName" required 
                           class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ุฑูู ุงูุทุงูุจ</label>
                    <input type="text" id="studentId" required 
                           class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base">
                </div>
                <div class="flex justify-end space-x-3 space-x-reverse">
                    <button type="button" onclick="closeAddStudentModal()" 
                            class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                        ุฅูุบุงุก
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-primary text-white hover:bg-purple-700 rounded-lg">
                        ุฅุถุงูุฉ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div id="editStudentModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4">ุชุนุฏูู ุจูุงูุงุช ุงูุทุงูุจ</h3>
            <form id="editStudentForm">
                <input type="hidden" id="editStudentOriginalId">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ุงุณู ุงูุทุงูุจ</label>
                    <input type="text" id="editStudentName" required 
                           class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ุฑูู ุงูุทุงูุจ</label>
                    <input type="text" id="editStudentId" required 
                           class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base">
                </div>
                <div class="flex justify-end space-x-3 space-x-reverse">
                    <button type="button" onclick="closeEditStudentModal()" 
                            class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                        ุฅูุบุงุก
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-primary text-white hover:bg-purple-700 rounded-lg">
                        ุญูุธ ุงูุชุนุฏูู
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
            <div class="flex items-center mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-2xl mr-3"></i>
                <h3 class="text-xl font-bold">ุชุฃููุฏ ุงูุญุฐู</h3>
            </div>
            <p class="text-gray-700 dark:text-gray-300 mb-6">
                ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูุทุงูุจุ ุณูุชู ุญุฐู ุฌููุน ุณุฌูุงุชู ููุงุฆูุงู ููุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.
            </p>
            <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3 mb-4">
                <p class="text-yellow-800 dark:text-yellow-200 text-sm">
                    <i class="fas fa-info-circle mr-1"></i>
                    ุณูุชู ุญุฐู: ุจูุงูุงุช ุงูุทุงูุจ + ุฌููุน ุณุฌูุงุช ุงูุฎุฑูุฌ ูุงูุนูุฏุฉ
                </p>
            </div>
            <div class="flex justify-end space-x-3 space-x-reverse">
                <button onclick="closeDeleteConfirmModal()" 
                        class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                    ุฅูุบุงุก
                </button>
                <button onclick="deleteStudentConfirmed()" 
                        class="px-4 py-2 bg-red-600 text-white hover:bg-red-700 rounded-lg">
                    <i class="fas fa-trash mr-1"></i>
                    ุญุฐู ููุงุฆู
                </button>
            </div>
        </div>
    </div>

    <!-- Student Profile Modal -->
    <div id="studentProfileModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-6xl max-h-[95vh] overflow-hidden flex flex-col">
            <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-600 flex-shrink-0">
                <div class="flex-1">
                    <h3 class="text-xl font-bold truncate mb-3" id="profileStudentName">ููู ุงูุทุงูุจ</h3>
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <button onclick="generateWhatsAppReport()" class="flex items-center justify-center w-12 h-12 bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-400 rounded-full hover:bg-green-200 dark:hover:bg-green-800 transition-colors group relative" title="ูุดุงุฑูุฉ ูู ุงููุงุชุณ ุงุจ">
                            <i class="fab fa-whatsapp text-xl"></i>
                            <span class="absolute bottom-full left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity mb-2 whitespace-nowrap">
                                ูุดุงุฑูุฉ ูุงุชุณ ุงุจ
                            </span>
                        </button>
                        <button onclick="printReport()" class="flex items-center justify-center w-12 h-12 bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-400 rounded-full hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors group relative" title="ุชุตุฏูุฑ PDF">
                            <i class="fas fa-file-pdf text-xl"></i>
                            <span class="absolute bottom-full left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity mb-2 whitespace-nowrap">
                                ุชุตุฏูุฑ PDF
                            </span>
                        </button>
                        <button onclick="exportAsImage()" class="flex items-center justify-center w-12 h-12 bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-400 rounded-full hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors group relative" title="ุชุตุฏูุฑ ูุตูุฑุฉ">
                            <i class="fas fa-image text-xl"></i>
                            <span class="absolute bottom-full left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity mb-2 whitespace-nowrap">
                                ุชุตุฏูุฑ ุตูุฑุฉ
                            </span>
                        </button>
                    </div>
                </div>
                <button onclick="closeStudentProfile()" class="text-gray-500 hover:text-gray-700 flex-shrink-0 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Student Stats -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg text-center min-w-0">
                        <div class="text-xl lg:text-2xl font-bold text-blue-600 truncate" id="profileTotalExits">0</div>
                        <div class="text-xs lg:text-sm text-gray-600 dark:text-gray-300">ุฅุฌูุงูู ุงูุฎุฑูุฌ</div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg text-center min-w-0">
                        <div class="text-xl lg:text-2xl font-bold text-orange-600 truncate" id="profileTotalMinutes">0</div>
                        <div class="text-xs lg:text-sm text-gray-600 dark:text-gray-300">ุฅุฌูุงูู ุงูุฏูุงุฆู</div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg text-center min-w-0">
                        <div class="text-xl lg:text-2xl font-bold text-green-600 truncate" id="profileAvgMinutes">0</div>
                        <div class="text-xs lg:text-sm text-gray-600 dark:text-gray-300">ูุชูุณุท ุงูุฏูุงุฆู</div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg text-center min-w-0">
                        <div class="text-xl lg:text-2xl font-bold text-purple-600 truncate" id="profileTodayExits">0</div>
                        <div class="text-xs lg:text-sm text-gray-600 dark:text-gray-300">ุฎุฑูุฌ ุงูููู</div>
                    </div>
                </div>
                
                <!-- Exit History -->
                <div class="min-w-0">
                    <h4 class="text-lg font-bold mb-4">ุณุฌู ุงูุฎุฑูุฌ ูุงูุนูุฏุฉ</h4>
                    <div class="overflow-x-auto border border-gray-300 dark:border-gray-600 rounded-lg">
                        <table class="w-full border-collapse min-w-[600px]">
                            <thead>
                                <tr class="bg-gray-50 dark:bg-gray-700">
                                    <th class="border-b border-gray-300 dark:border-gray-600 p-3 text-right text-sm font-medium">ุงูุชุงุฑูุฎ</th>
                                    <th class="border-b border-gray-300 dark:border-gray-600 p-3 text-right text-sm font-medium">ููุช ุงูุฎุฑูุฌ</th>
                                    <th class="border-b border-gray-300 dark:border-gray-600 p-3 text-right text-sm font-medium">ููุช ุงูุนูุฏุฉ</th>
                                    <th class="border-b border-gray-300 dark:border-gray-600 p-3 text-right text-sm font-medium">ุงููุฏุฉ</th>
                                    <th class="border-b border-gray-300 dark:border-gray-600 p-3 text-right text-sm font-medium">ุงูุญุงูุฉ</th>
                                </tr>
                            </thead>
                            <tbody id="profileExitHistory">
                                <!-- Exit history will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode support
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // IndexedDB setup
        let db;
        const DB_NAME = 'StudentTracking';
        const DB_VERSION = 1;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    // Students store
                    if (!db.objectStoreNames.contains('students')) {
                        const studentsStore = db.createObjectStore('students', { keyPath: 'id' });
                        studentsStore.createIndex('name', 'name');
                    }
                    
                    // Exit logs store
                    if (!db.objectStoreNames.contains('exitLogs')) {
                        const logsStore = db.createObjectStore('exitLogs', { keyPath: 'id', autoIncrement: true });
                        logsStore.createIndex('studentId', 'studentId');
                        logsStore.createIndex('date', 'date');
                    }
                };
            });
        }

        // Database operations
        function addStudent(student) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['students'], 'readwrite');
                const store = transaction.objectStore('students');
                const request = store.add(student);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getAllStudents() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['students'], 'readonly');
                const store = transaction.objectStore('students');
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function updateStudent(student) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['students'], 'readwrite');
                const store = transaction.objectStore('students');
                const request = store.put(student);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function addExitLog(log) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['exitLogs'], 'readwrite');
                const store = transaction.objectStore('exitLogs');
                const request = store.add(log);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getStudentLogs(studentId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['exitLogs'], 'readonly');
                const store = transaction.objectStore('exitLogs');
                const index = store.index('studentId');
                const request = index.getAll(studentId);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function updateExitLog(log) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['exitLogs'], 'readwrite');
                const store = transaction.objectStore('exitLogs');
                const request = store.put(log);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // App state
        let students = [];
        let timers = {};

        // Initialize app
        async function initApp() {
            try {
                await initDB();
                await loadStudents();
                updateStatistics();
                startClock();
                setupEventListeners();
                
                // No sample students - user will add manually
            } catch (error) {
                console.error('Error initializing app:', error);
            }
        }

        // Delete student function
        function deleteStudent(studentId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['students'], 'readwrite');
                const store = transaction.objectStore('students');
                const request = store.delete(studentId);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Delete student logs function
        function deleteStudentLogs(studentId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['exitLogs'], 'readwrite');
                const store = transaction.objectStore('exitLogs');
                const index = store.index('studentId');
                const request = index.openCursor(studentId);
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        cursor.delete();
                        cursor.continue();
                    } else {
                        resolve();
                    }
                };
                request.onerror = () => reject(request.error);
            });
        }

        async function loadStudents() {
            students = await getAllStudents();
            renderStudents();
        }

        function renderStudents() {
            const container = document.getElementById('studentsList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            
            const filteredStudents = students.filter(student => {
                const matchesSearch = student.name.toLowerCase().includes(searchTerm);
                const matchesStatus = statusFilter === 'all' || student.status === statusFilter;
                return matchesSearch && matchesStatus;
            });
            
            container.innerHTML = filteredStudents.map(student => {
                const isOutside = student.status === 'outside';
                const timer = timers[student.id];
                
                return `
                    <div class="student-card bg-white dark:bg-gray-700 p-4 rounded-lg shadow-md border-r-4 ${isOutside ? 'border-red-500' : 'border-green-500'} min-w-0">
                        <div class="flex items-start justify-between mb-3 gap-3">
                            <button onclick="openStudentProfile('${student.id}')" 
                                    class="text-lg font-bold text-primary hover:text-purple-700 text-right truncate flex-1 min-w-0">
                                ${student.name}
                            </button>
                            <div class="flex items-center space-x-2 space-x-reverse flex-shrink-0">
                                <span class="text-sm text-gray-600 dark:text-gray-300 truncate">${student.id}</span>
                                <span class="w-3 h-3 rounded-full flex-shrink-0 ${isOutside ? 'bg-red-500' : 'bg-green-500'}"></span>
                            </div>
                        </div>
                        
                        <div class="mb-3 space-y-1">
                            <div class="text-sm text-gray-600 dark:text-gray-300">
                                ุงูุญุงูุฉ: <span class="font-medium ${isOutside ? 'text-red-600' : 'text-green-600'}">${isOutside ? 'ุฎุงุฑุฌ ุงููุตู' : 'ุฏุงุฎู ุงููุตู'}</span>
                            </div>
                            ${isOutside && timer ? `
                                <div class="text-sm text-orange-600 timer-active">
                                    ุฎุงุฑุฌ ููุฐ: <span class="font-mono">${timer}</span>
                                </div>
                            ` : ''}
                            <div class="text-sm text-gray-600 dark:text-gray-300">
                                ุฅุฌูุงูู ุงูุฏูุงุฆู: <span class="font-medium">${student.totalMinutes || 0}</span>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            ${isOutside ? `
                                <button onclick="markReturn('${student.id}')" 
                                        class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-base">
                                    <i class="fas fa-arrow-left mr-1"></i>
                                    ุนูุฏุฉ
                                </button>
                            ` : `
                                <button onclick="markExit('${student.id}')" 
                                        class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-base">
                                    <i class="fas fa-arrow-right mr-1"></i>
                                    ุฎุฑูุฌ
                                </button>
                            `}
                            <div class="flex space-x-2 space-x-reverse">
                                <button onclick="editStudent('${student.id}')" 
                                        class="flex-1 bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                    <i class="fas fa-edit mr-1"></i>
                                    ุชุนุฏูู
                                </button>
                                <button onclick="confirmDeleteStudent('${student.id}')" 
                                        class="flex-1 bg-gray-600 text-white px-3 py-2 rounded-lg hover:bg-gray-700 transition-colors text-sm">
                                    <i class="fas fa-trash mr-1"></i>
                                    ุญุฐู
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function markExit(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student || student.status === 'outside') return;
            
            const now = new Date();
            
            // Update student status
            student.status = 'outside';
            student.currentExitTime = now.toISOString();
            student.totalExits = (student.totalExits || 0) + 1;
            
            // Create exit log
            const exitLog = {
                studentId: studentId,
                studentName: student.name,
                exitTime: now.toISOString(),
                returnTime: null,
                duration: null,
                date: now.toISOString().split('T')[0]
            };
            
            await Promise.all([
                updateStudent(student),
                addExitLog(exitLog)
            ]);
            
            // Start timer
            startTimer(studentId, now);
            
            renderStudents();
            updateStatistics();
        }

        async function markReturn(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student || student.status === 'inside') return;
            
            const now = new Date();
            const exitTime = new Date(student.currentExitTime);
            const durationSeconds = Math.round((now - exitTime) / 1000); // total seconds
            const durationMinutes = Math.round(durationSeconds / 60); // rounded minutes for summary
            
            // Update student
            student.status = 'inside';
            student.totalMinutes = (student.totalMinutes || 0) + durationMinutes;
            student.totalSeconds = (student.totalSeconds || 0) + durationSeconds;
            delete student.currentExitTime;
            
            // Find and update the latest exit log
            const logs = await getStudentLogs(studentId);
            const latestLog = logs.filter(log => !log.returnTime).sort((a, b) => new Date(b.exitTime) - new Date(a.exitTime))[0];
            
            if (latestLog) {
                latestLog.returnTime = now.toISOString();
                latestLog.durationSeconds = durationSeconds;
                latestLog.duration = durationMinutes; // Keep for backward compatibility
                await updateExitLog(latestLog);
            }
            
            await updateStudent(student);
            
            // Stop timer
            stopTimer(studentId);
            
            renderStudents();
            updateStatistics();
        }

        function startTimer(studentId, startTime) {
            timers[studentId] = setInterval(() => {
                const now = new Date();
                const diff = now - startTime;
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                
                let timeDisplay = '';
                if (hours > 0) {
                    timeDisplay = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                } else {
                    timeDisplay = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
                
                timers[studentId] = timeDisplay;
                renderStudents();
            }, 1000);
        }

        function stopTimer(studentId) {
            if (timers[studentId]) {
                clearInterval(timers[studentId]);
                delete timers[studentId];
            }
        }

        function updateStatistics() {
            const inside = students.filter(s => s.status === 'inside').length;
            const outside = students.filter(s => s.status === 'outside').length;
            const total = students.length;
            
            const today = new Date().toISOString().split('T')[0];
            const todayExits = students.reduce((sum, s) => sum + (s.totalExits || 0), 0);
            
            document.getElementById('studentsInside').textContent = inside;
            document.getElementById('studentsOutside').textContent = outside;
            document.getElementById('totalStudents').textContent = total;
            document.getElementById('todayExits').textContent = todayExits;
        }

        function startClock() {
            function updateClock() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('ar-SA', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                document.getElementById('currentTime').textContent = timeString;
            }
            
            updateClock();
            setInterval(updateClock, 1000);
        }

        async function openStudentProfile(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const logs = await getStudentLogs(studentId);
            const completedLogs = logs.filter(log => log.returnTime);
            
            // Store for reports
            currentStudentForReport = student;
            currentLogsForReport = logs;
            
            // Calculate statistics
            const totalExits = student.totalExits || 0;
            const totalMinutes = student.totalMinutes || 0;
            const avgMinutes = totalExits > 0 ? Math.round(totalMinutes / totalExits) : 0;
            
            const today = new Date().toISOString().split('T')[0];
            const todayExits = logs.filter(log => log.date === today).length;
            
            // Update modal content
            document.getElementById('profileStudentName').textContent = `ููู ุงูุทุงูุจ: ${student.name}`;
            document.getElementById('profileTotalExits').textContent = totalExits;
            document.getElementById('profileTotalMinutes').textContent = totalMinutes;
            document.getElementById('profileAvgMinutes').textContent = avgMinutes;
            document.getElementById('profileTodayExits').textContent = todayExits;
            
            // Render exit history
            const historyContainer = document.getElementById('profileExitHistory');
            historyContainer.innerHTML = logs.sort((a, b) => new Date(b.exitTime) - new Date(a.exitTime))
                .map(log => {
                    const exitTime = new Date(log.exitTime);
                    const returnTime = log.returnTime ? new Date(log.returnTime) : null;
                    const status = returnTime ? 'ุนุงุฏ' : 'ุฎุงุฑุฌ';
                    
                    // Format duration precisely
                    let durationDisplay = '-';
                    if (returnTime) {
                        const durationSeconds = log.durationSeconds || Math.round((returnTime - exitTime) / 1000);
                        const hours = Math.floor(durationSeconds / 3600);
                        const minutes = Math.floor((durationSeconds % 3600) / 60);
                        const seconds = durationSeconds % 60;
                        
                        if (hours > 0) {
                            durationDisplay = `${hours}ุณ ${minutes}ุฏ ${seconds}ุซ`;
                        } else if (minutes > 0) {
                            durationDisplay = `${minutes}ุฏ ${seconds}ุซ`;
                        } else {
                            durationDisplay = `${seconds}ุซ`;
                        }
                    } else if (log.exitTime) {
                        // For current outside students, calculate live duration
                        const now = new Date();
                        const currentDurationSeconds = Math.round((now - exitTime) / 1000);
                        const hours = Math.floor(currentDurationSeconds / 3600);
                        const minutes = Math.floor((currentDurationSeconds % 3600) / 60);
                        const seconds = currentDurationSeconds % 60;
                        
                        if (hours > 0) {
                            durationDisplay = `${hours}ุณ ${minutes}ุฏ ${seconds}ุซ (ูุณุชูุฑ)`;
                        } else if (minutes > 0) {
                            durationDisplay = `${minutes}ุฏ ${seconds}ุซ (ูุณุชูุฑ)`;
                        } else {
                            durationDisplay = `${seconds}ุซ (ูุณุชูุฑ)`;
                        }
                    }
                    
                    return `
                        <tr class="${!returnTime ? 'bg-red-50 dark:bg-red-900/20' : ''}">
                            <td class="border-b border-gray-200 dark:border-gray-600 p-3 text-sm whitespace-nowrap">${exitTime.toLocaleDateString('ar-SA')}</td>
                            <td class="border-b border-gray-200 dark:border-gray-600 p-3 text-sm whitespace-nowrap">${exitTime.toLocaleTimeString('ar-SA')}</td>
                            <td class="border-b border-gray-200 dark:border-gray-600 p-3 text-sm whitespace-nowrap">${returnTime ? returnTime.toLocaleTimeString('ar-SA') : '-'}</td>
                            <td class="border-b border-gray-200 dark:border-gray-600 p-3 text-sm whitespace-nowrap font-mono">${durationDisplay}</td>
                            <td class="border-b border-gray-200 dark:border-gray-600 p-3 text-sm">
                                <span class="px-2 py-1 rounded text-xs whitespace-nowrap ${returnTime ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}">
                                    ${status}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');
            
            document.getElementById('studentProfileModal').classList.remove('hidden');
            document.getElementById('studentProfileModal').classList.add('flex');
        }

        function closeStudentProfile() {
            document.getElementById('studentProfileModal').classList.add('hidden');
            document.getElementById('studentProfileModal').classList.remove('flex');
        }

        function openAddStudentModal() {
            document.getElementById('addStudentModal').classList.remove('hidden');
            document.getElementById('addStudentModal').classList.add('flex');
        }

        function closeAddStudentModal() {
            document.getElementById('addStudentModal').classList.add('hidden');
            document.getElementById('addStudentModal').classList.remove('flex');
            document.getElementById('addStudentForm').reset();
        }

        function setupEventListeners() {
            // Add student button
            document.getElementById('addStudentBtn').addEventListener('click', openAddStudentModal);
            
            // Add student form
            document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const name = document.getElementById('studentName').value.trim();
                const id = document.getElementById('studentId').value.trim();
                
                if (!name || !id) return;
                
                // Check if student ID already exists
                if (students.find(s => s.id === id)) {
                    alert('ุฑูู ุงูุทุงูุจ ููุฌูุฏ ุจุงููุนู');
                    return;
                }
                
                const newStudent = {
                    id: id,
                    name: name,
                    status: 'inside',
                    totalMinutes: 0,
                    totalExits: 0
                };
                
                try {
                    await addStudent(newStudent);
                    students.push(newStudent);
                    renderStudents();
                    updateStatistics();
                    closeAddStudentModal();
                } catch (error) {
                    console.error('Error adding student:', error);
                    alert('ุญุฏุซ ุฎุทุฃ ูู ุฅุถุงูุฉ ุงูุทุงูุจ');
                }
            });
            
            // Search and filter
            document.getElementById('searchInput').addEventListener('input', renderStudents);
            document.getElementById('filterStatus').addEventListener('change', renderStudents);
            
            // Initialize timers for students currently outside
            students.filter(s => s.status === 'outside' && s.currentExitTime).forEach(student => {
                startTimer(student.id, new Date(student.currentExitTime));
            });
        }

        // Edit student functions
        function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            document.getElementById('editStudentOriginalId').value = student.id;
            document.getElementById('editStudentName').value = student.name;
            document.getElementById('editStudentId').value = student.id;
            
            document.getElementById('editStudentModal').classList.remove('hidden');
            document.getElementById('editStudentModal').classList.add('flex');
        }

        function closeEditStudentModal() {
            document.getElementById('editStudentModal').classList.add('hidden');
            document.getElementById('editStudentModal').classList.remove('flex');
            document.getElementById('editStudentForm').reset();
        }

        // Delete student functions
        let studentToDelete = null;

        function confirmDeleteStudent(studentId) {
            studentToDelete = studentId;
            document.getElementById('deleteConfirmModal').classList.remove('hidden');
            document.getElementById('deleteConfirmModal').classList.add('flex');
        }

        function closeDeleteConfirmModal() {
            studentToDelete = null;
            document.getElementById('deleteConfirmModal').classList.add('hidden');
            document.getElementById('deleteConfirmModal').classList.remove('flex');
        }

        async function deleteStudentConfirmed() {
            if (!studentToDelete) return;
            
            try {
                // Stop timer if student is outside
                stopTimer(studentToDelete);
                
                // Delete from database
                await Promise.all([
                    deleteStudent(studentToDelete),
                    deleteStudentLogs(studentToDelete)
                ]);
                
                // Remove from local array
                const index = students.findIndex(s => s.id === studentToDelete);
                if (index > -1) {
                    students.splice(index, 1);
                }
                
                renderStudents();
                updateStatistics();
                closeDeleteConfirmModal();
                
                showSuccessMessage('ุชู ุญุฐู ุงูุทุงูุจ ุจูุฌุงุญ');
            } catch (error) {
                console.error('Error deleting student:', error);
                showErrorMessage('ุญุฏุซ ุฎุทุฃ ูู ุญุฐู ุงูุทุงูุจ');
            }
        }

        // Success/Error message functions
        function showSuccessMessage(message) {
            showMessage(message, 'success');
        }

        function showErrorMessage(message) {
            showMessage(message, 'error');
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            
            messageDiv.className = `fixed top-4 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(messageDiv);
                }, 300);
            }, 3000);
        }

        // Setup additional event listeners for edit and delete
        function setupAdditionalEventListeners() {
            // Edit student form
            document.getElementById('editStudentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const originalId = document.getElementById('editStudentOriginalId').value;
                const newName = document.getElementById('editStudentName').value.trim();
                const newId = document.getElementById('editStudentId').value.trim();
                
                if (!newName || !newId) return;
                
                // Check if new ID already exists (and it's different from original)
                if (newId !== originalId && students.find(s => s.id === newId)) {
                    showErrorMessage('ุฑูู ุงูุทุงูุจ ููุฌูุฏ ุจุงููุนู');
                    return;
                }
                
                try {
                    const student = students.find(s => s.id === originalId);
                    if (!student) return;
                    
                    // If ID changed, we need to handle it specially
                    if (newId !== originalId) {
                        // Create new student with new ID
                        const newStudent = { ...student, id: newId, name: newName };
                        
                        // Update logs to point to new ID
                        const logs = await getStudentLogs(originalId);
                        for (const log of logs) {
                            log.studentId = newId;
                            await updateExitLog(log);
                        }
                        
                        // Add new student and delete old one
                        await addStudent(newStudent);
                        await deleteStudent(originalId);
                        
                        // Update timers
                        if (timers[originalId]) {
                            timers[newId] = timers[originalId];
                            delete timers[originalId];
                        }
                        
                        // Update local array
                        const index = students.findIndex(s => s.id === originalId);
                        if (index > -1) {
                            students[index] = newStudent;
                        }
                    } else {
                        // Just update name
                        student.name = newName;
                        await updateStudent(student);
                    }
                    
                    renderStudents();
                    closeEditStudentModal();
                    showSuccessMessage('ุชู ุชุนุฏูู ุจูุงูุงุช ุงูุทุงูุจ ุจูุฌุงุญ');
                } catch (error) {
                    console.error('Error updating student:', error);
                    showErrorMessage('ุญุฏุซ ุฎุทุฃ ูู ุชุนุฏูู ุงูุทุงูุจ');
                }
            });
        }

        // Report generation functions
        let currentStudentForReport = null;
        let currentLogsForReport = null;

        async function generateWhatsAppReport() {
            if (!currentStudentForReport) return;
            
            const student = currentStudentForReport;
            const logs = currentLogsForReport;
            const today = new Date().toLocaleDateString('ar-SA');
            const currentTime = new Date().toLocaleTimeString('ar-SA');
            
            // Calculate statistics
            const totalExits = student.totalExits || 0;
            const totalMinutes = student.totalMinutes || 0;
            const totalSeconds = student.totalSeconds || 0;
            const avgMinutes = totalExits > 0 ? Math.round(totalMinutes / totalExits) : 0;
            
            // Format total time
            let totalTimeFormatted = '';
            if (totalSeconds > 0) {
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                
                if (hours > 0) {
                    totalTimeFormatted = `${hours} ุณุงุนุฉ ${minutes} ุฏูููุฉ ${seconds} ุซุงููุฉ`;
                } else if (minutes > 0) {
                    totalTimeFormatted = `${minutes} ุฏูููุฉ ${seconds} ุซุงููุฉ`;
                } else {
                    totalTimeFormatted = `${seconds} ุซุงููุฉ`;
                }
            } else {
                totalTimeFormatted = 'ูุง ููุฌุฏ';
            }
            
            const todayDate = new Date().toISOString().split('T')[0];
            const todayExits = logs.filter(log => log.date === todayDate).length;
            
            // Generate WhatsApp report text
            let reportText = `๐ *ุชูุฑูุฑ ูุชุงุจุนุฉ ุงูุทุงูุจ*\n`;
            reportText += `โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n\n`;
            reportText += `๐ค *ุงุณู ุงูุทุงูุจ:* ${student.name}\n`;
            reportText += `๐ *ุฑูู ุงูุทุงูุจ:* ${student.id}\n`;
            reportText += `๐ *ุชุงุฑูุฎ ุงูุชูุฑูุฑ:* ${today}\n`;
            reportText += `๐ *ููุช ุฅูุดุงุก ุงูุชูุฑูุฑ:* ${currentTime}\n\n`;
            
            reportText += `๐ *ุงูุฅุญุตุงุฆูุงุช ุงูุนุงูุฉ:*\n`;
            reportText += `โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n`;
            reportText += `๐ข ุฅุฌูุงูู ูุฑุงุช ุงูุฎุฑูุฌ: *${totalExits}*\n`;
            reportText += `โฐ ุฅุฌูุงูู ุงูููุช ุงูููุถู ุฎุงุฑุฌ ุงููุตู: *${totalTimeFormatted}*\n`;
            reportText += `๐ ูุชูุณุท ููุช ุงูุฎุฑูุฌ: *${avgMinutes} ุฏูููุฉ*\n`;
            reportText += `๐ ุฎุฑูุฌ ุงูููู: *${todayExits} ูุฑุฉ*\n\n`;
            
            reportText += `๐ *ุงูุณุฌู ุงูุชูุตููู:*\n`;
            reportText += `โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n`;
            
            if (logs.length > 0) {
                const recentLogs = logs.sort((a, b) => new Date(b.exitTime) - new Date(a.exitTime)).slice(0, 10);
                
                recentLogs.forEach((log, index) => {
                    const exitTime = new Date(log.exitTime);
                    const returnTime = log.returnTime ? new Date(log.returnTime) : null;
                    const date = exitTime.toLocaleDateString('ar-SA');
                    const exitTimeStr = exitTime.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                    
                    reportText += `${index + 1}. ๐ ${date}\n`;
                    reportText += `   ๐ชโก๏ธ ุฎุฑูุฌ: ${exitTimeStr}\n`;
                    
                    if (returnTime) {
                        const returnTimeStr = returnTime.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                        const durationSeconds = log.durationSeconds || Math.round((returnTime - exitTime) / 1000);
                        const hours = Math.floor(durationSeconds / 3600);
                        const minutes = Math.floor((durationSeconds % 3600) / 60);
                        const seconds = durationSeconds % 60;
                        
                        let durationText = '';
                        if (hours > 0) {
                            durationText = `${hours}ุณ ${minutes}ุฏ ${seconds}ุซ`;
                        } else if (minutes > 0) {
                            durationText = `${minutes}ุฏ ${seconds}ุซ`;
                        } else {
                            durationText = `${seconds}ุซ`;
                        }
                        
                        reportText += `   ๐ชโฌ๏ธ ุนูุฏุฉ: ${returnTimeStr}\n`;
                        reportText += `   โฑ๏ธ ุงููุฏุฉ: ${durationText}\n`;
                        reportText += `   โ *ููุชูู*\n\n`;
                    } else {
                        reportText += `   โ *ูู ูุนุฏ ุจุนุฏ*\n\n`;
                    }
                });
                
                if (logs.length > 10) {
                    reportText += `... ู ${logs.length - 10} ุณุฌู ุฅุถุงูู\n\n`;
                }
            } else {
                reportText += `ูุง ุชูุฌุฏ ุณุฌูุงุช ุฎุฑูุฌ ูุณุฌูุฉ\n\n`;
            }
            
            reportText += `โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n`;
            reportText += `๐ซ *ูุธุงู ูุชุงุจุนุฉ ุงูุทูุงุจ*\n`;
            reportText += `ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุชููุงุฆูุงู`;
            
            // Copy to clipboard or share
            try {
                if (navigator.share) {
                    // Use Web Share API if available
                    await navigator.share({
                        title: `ุชูุฑูุฑ ุงูุทุงูุจ: ${student.name}`,
                        text: reportText
                    });
                    showSuccessMessage('ุชู ูุดุงุฑูุฉ ุงูุชูุฑูุฑ ุจูุฌุงุญ');
                } else {
                    // Fallback to clipboard
                    await navigator.clipboard.writeText(reportText);
                    showSuccessMessage('ุชู ูุณุฎ ุงูุชูุฑูุฑ ููุญุงูุธุฉ - ููููู ูุตูู ูู ุงููุงุชุณ ุงุจ');
                }
            } catch (error) {
                // Final fallback - show report in modal
                showReportInModal(reportText);
            }
        }

        function showReportInModal(reportText) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-lg w-full max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-600">
                        <h3 class="text-lg font-bold">ุชูุฑูุฑ ุงููุงุชุณ ุงุจ</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4">
                        <textarea readonly class="w-full h-64 p-3 border rounded-lg resize-none font-mono text-sm" style="white-space: pre-wrap;">${reportText}</textarea>
                    </div>
                    <div class="p-4 border-t border-gray-200 dark:border-gray-600">
                        <button onclick="copyReportText('${reportText.replace(/'/g, "\\'")}'); this.closest('.fixed').remove();" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            ูุณุฎ ุงููุต
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function copyReportText(text) {
            try {
                await navigator.clipboard.writeText(text);
                showSuccessMessage('ุชู ูุณุฎ ุงูุชูุฑูุฑ ููุญุงูุธุฉ');
            } catch (error) {
                showErrorMessage('ูุดู ูู ูุณุฎ ุงููุต');
            }
        }

        async function printReport() {
            if (!currentStudentForReport) return;
            
            const student = currentStudentForReport;
            const logs = currentLogsForReport;
            const today = new Date().toLocaleDateString('ar-SA');
            const currentTime = new Date().toLocaleTimeString('ar-SA');
            
            // Calculate statistics
            const totalExits = student.totalExits || 0;
            const totalMinutes = student.totalMinutes || 0;
            const totalSeconds = student.totalSeconds || 0;
            const avgMinutes = totalExits > 0 ? Math.round(totalMinutes / totalExits) : 0;
            
            // Format total time
            let totalTimeFormatted = '';
            if (totalSeconds > 0) {
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                
                if (hours > 0) {
                    totalTimeFormatted = `${hours} ุณุงุนุฉ ${minutes} ุฏูููุฉ ${seconds} ุซุงููุฉ`;
                } else if (minutes > 0) {
                    totalTimeFormatted = `${minutes} ุฏูููุฉ ${seconds} ุซุงููุฉ`;
                } else {
                    totalTimeFormatted = `${seconds} ุซุงููุฉ`;
                }
            } else {
                totalTimeFormatted = 'ูุง ููุฌุฏ';
            }
            
            const todayDate = new Date().toISOString().split('T')[0];
            const todayExits = logs.filter(log => log.date === todayDate).length;
            
            // Show loading message
            showLoadingMessage('ุฌุงุฑู ุฅูุดุงุก ููู PDF...');
            
            try {
                // Create a temporary div with the report content
                const reportDiv = document.createElement('div');
                reportDiv.style.cssText = `
                    position: fixed;
                    top: -9999px;
                    left: -9999px;
                    width: 800px;
                    padding: 40px;
                    background: white;
                    font-family: 'Cairo', sans-serif;
                    direction: rtl;
                    color: #333;
                `;
                
                reportDiv.innerHTML = `
                    <div style="padding: 30px;">
                        <!-- Header -->
                        <div style="text-align: center; border-bottom: 3px solid #5D5CDE; padding-bottom: 20px; margin-bottom: 30px;">
                            <h1 style="color: #5D5CDE; font-size: 2.2em; margin-bottom: 10px; font-weight: bold;">๐ ุชูุฑูุฑ ูุชุงุจุนุฉ ุงูุทุงูุจ</h1>
                            <div style="color: #666; font-size: 1.1em;">ูุธุงู ูุชุงุจุนุฉ ุฏุฎูู ูุฎุฑูุฌ ุงูุทูุงุจ</div>
                        </div>
                        
                        <!-- Student Info -->
                        <div style="background: linear-gradient(45deg, #f8f9fa, #e9ecef); padding: 25px; border-radius: 15px; margin-bottom: 25px; border-right: 5px solid #5D5CDE;">
                            <h2 style="color: #5D5CDE; margin-bottom: 20px; font-size: 1.4em; font-weight: bold;">๐ ุจูุงูุงุช ุงูุทุงูุจ</h2>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div style="display: flex; align-items: center;">
                                    <strong style="color: #333; margin-left: 10px; min-width: 120px;">ุงุณู ุงูุทุงูุจ:</strong>
                                    <span style="font-weight: 600; color: #5D5CDE;">${student.name}</span>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <strong style="color: #333; margin-left: 10px; min-width: 120px;">ุฑูู ุงูุทุงูุจ:</strong>
                                    <span style="font-weight: 600; color: #5D5CDE;">${student.id}</span>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <strong style="color: #333; margin-left: 10px; min-width: 120px;">ุชุงุฑูุฎ ุงูุชูุฑูุฑ:</strong>
                                    <span>${today}</span>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <strong style="color: #333; margin-left: 10px; min-width: 120px;">ููุช ุงูุฅูุดุงุก:</strong>
                                    <span>${currentTime}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Statistics -->
                        <div style="margin-bottom: 25px;">
                            <h2 style="color: #5D5CDE; margin-bottom: 20px; font-size: 1.4em; border-bottom: 2px solid #eee; padding-bottom: 10px; font-weight: bold;">๐ ุงูุฅุญุตุงุฆูุงุช ุงูุนุงูุฉ</h2>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                                <div style="background: linear-gradient(45deg, #e3f2fd, #bbdefb); border: 2px solid #2196f3; border-radius: 12px; padding: 20px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold; color: #1976d2; margin-bottom: 5px;">${totalExits}</div>
                                    <div style="color: #333; font-size: 0.9em; font-weight: 600;">ุฅุฌูุงูู ูุฑุงุช ุงูุฎุฑูุฌ</div>
                                </div>
                                <div style="background: linear-gradient(45deg, #fff3e0, #ffcc02); border: 2px solid #ff9800; border-radius: 12px; padding: 20px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold; color: #f57c00; margin-bottom: 5px;">${totalMinutes}</div>
                                    <div style="color: #333; font-size: 0.9em; font-weight: 600;">ุฅุฌูุงูู ุงูุฏูุงุฆู</div>
                                </div>
                                <div style="background: linear-gradient(45deg, #e8f5e8, #c8e6c9); border: 2px solid #4caf50; border-radius: 12px; padding: 20px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold; color: #388e3c; margin-bottom: 5px;">${avgMinutes}</div>
                                    <div style="color: #333; font-size: 0.9em; font-weight: 600;">ูุชูุณุท ููุช ุงูุฎุฑูุฌ (ุฏูููุฉ)</div>
                                </div>
                                <div style="background: linear-gradient(45deg, #fce4ec, #f8bbd9); border: 2px solid #e91e63; border-radius: 12px; padding: 20px; text-align: center;">
                                    <div style="font-size: 2em; font-weight: bold; color: #c2185b; margin-bottom: 5px;">${todayExits}</div>
                                    <div style="color: #333; font-size: 0.9em; font-weight: 600;">ุฎุฑูุฌ ุงูููู</div>
                                </div>
                            </div>
                            <div style="text-align: center; background: linear-gradient(45deg, #e3f2fd, #bbdefb); padding: 15px; border-radius: 10px; border: 2px solid #2196f3;">
                                <strong style="color: #333;">ุฅุฌูุงูู ุงูููุช ุงูููุถู ุฎุงุฑุฌ ุงููุตู: </strong>
                                <span style="color: #1976d2; font-weight: bold; font-size: 1.2em;">${totalTimeFormatted}</span>
                            </div>
                        </div>
                        
                        <!-- History Table -->
                        <div style="margin-bottom: 25px;">
                            <h2 style="color: #5D5CDE; margin-bottom: 20px; font-size: 1.4em; border-bottom: 2px solid #eee; padding-bottom: 10px; font-weight: bold;">๐ ุงูุณุฌู ุงูุชูุตููู ููุฎุฑูุฌ ูุงูุนูุฏุฉ</h2>
                            <div style="background: #f8f9fa; border-radius: 10px; overflow: hidden; border: 1px solid #dee2e6;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #5D5CDE; color: white;">
                                            <th style="padding: 12px; text-align: center; font-weight: 600; border-bottom: 1px solid #ddd;">ุงูุชุงุฑูุฎ</th>
                                            <th style="padding: 12px; text-align: center; font-weight: 600; border-bottom: 1px solid #ddd;">ุงูุฎุฑูุฌ</th>
                                            <th style="padding: 12px; text-align: center; font-weight: 600; border-bottom: 1px solid #ddd;">ุงูุนูุฏุฉ</th>
                                            <th style="padding: 12px; text-align: center; font-weight: 600; border-bottom: 1px solid #ddd;">ุงููุฏุฉ</th>
                                            <th style="padding: 12px; text-align: center; font-weight: 600; border-bottom: 1px solid #ddd;">ุงูุญุงูุฉ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${logs.sort((a, b) => new Date(b.exitTime) - new Date(a.exitTime)).map((log, index) => {
                                            const exitTime = new Date(log.exitTime);
                                            const returnTime = log.returnTime ? new Date(log.returnTime) : null;
                                            
                                            let durationDisplay = '-';
                                            if (returnTime) {
                                                const durationSeconds = log.durationSeconds || Math.round((returnTime - exitTime) / 1000);
                                                const hours = Math.floor(durationSeconds / 3600);
                                                const minutes = Math.floor((durationSeconds % 3600) / 60);
                                                const seconds = durationSeconds % 60;
                                                
                                                if (hours > 0) {
                                                    durationDisplay = `${hours}ุณ ${minutes}ุฏ ${seconds}ุซ`;
                                                } else if (minutes > 0) {
                                                    durationDisplay = `${minutes}ุฏ ${seconds}ุซ`;
                                                } else {
                                                    durationDisplay = `${seconds}ุซ`;
                                                }
                                            }
                                            
                                            const status = returnTime ? 'ููุชูู' : 'ุบูุฑ ููุชูู';
                                            const statusStyle = returnTime ? 
                                                'background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold;' : 
                                                'background: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold;';
                                            const rowStyle = index % 2 === 1 ? 'background: #f8f9fa;' : 'background: white;';
                                            
                                            return `
                                                <tr style="${rowStyle}">
                                                    <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd; font-size: 0.9em;">${exitTime.toLocaleDateString('ar-SA')}</td>
                                                    <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd; font-size: 0.9em;">${exitTime.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}</td>
                                                    <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd; font-size: 0.9em;">${returnTime ? returnTime.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }) : '-'}</td>
                                                    <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd; font-size: 0.9em; font-family: monospace;">${durationDisplay}</td>
                                                    <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd;"><span style="${statusStyle}">${status}</span></td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                                ${logs.length === 0 ? '<p style="text-align: center; padding: 20px; color: #666;">ูุง ุชูุฌุฏ ุณุฌูุงุช ูุชุงุญุฉ</p>' : ''}
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee; color: #666;">
                            <div style="font-size: 1.1em; color: #5D5CDE; font-weight: bold; margin-bottom: 5px;">๐ซ ูุธุงู ูุชุงุจุนุฉ ุงูุทูุงุจ</div>
                            <div style="font-size: 0.9em;">ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุชููุงุฆูุงู ูู ${today} ุงูุณุงุนุฉ ${currentTime}</div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(reportDiv);
                
                // Convert to canvas
                const canvas = await html2canvas(reportDiv, {
                    width: 800,
                    height: reportDiv.scrollHeight + 80,
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    allowTaint: true,
                    removeContainer: true
                });
                
                // Remove the temporary div
                document.body.removeChild(reportDiv);
                
                // Convert canvas to image data
                const imgData = canvas.toDataURL('image/png', 1.0);
                
                // Create PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Calculate dimensions
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = pdfWidth - 20; // 10mm margin on each side
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Add image to PDF
                let yPosition = 10;
                let remainingHeight = imgHeight;
                
                while (remainingHeight > 0) {
                    const pageHeight = Math.min(remainingHeight, pdfHeight - 20);
                    
                    pdf.addImage(
                        imgData,
                        'PNG',
                        10,
                        yPosition,
                        imgWidth,
                        imgHeight,
                        '',
                        'FAST',
                        0
                    );
                    
                    remainingHeight -= (pdfHeight - 20);
                    
                    if (remainingHeight > 0) {
                        pdf.addPage();
                        yPosition = -(imgHeight - remainingHeight) + 10;
                    }
                }
                
                // Save PDF
                const fileName = `ุชูุฑูุฑ_ุงูุทุงูุจ_${student.name}_${today.replace(/\//g, '-')}.pdf`;
                pdf.save(fileName);
                
                hideLoadingMessage();
                showSuccessMessage('ุชู ุชุตุฏูุฑ ุงูุชูุฑูุฑ ูู PDF ุจูุฌุงุญ');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                hideLoadingMessage();
                showFallbackPDFExport();
            }
        }

        async function exportAsImage() {
            if (!currentStudentForReport) return;
            
            const student = currentStudentForReport;
            const logs = currentLogsForReport;
            const today = new Date().toLocaleDateString('ar-SA');
            const currentTime = new Date().toLocaleTimeString('ar-SA');
            
            // Calculate statistics
            const totalExits = student.totalExits || 0;
            const totalMinutes = student.totalMinutes || 0;
            const totalSeconds = student.totalSeconds || 0;
            const avgMinutes = totalExits > 0 ? Math.round(totalMinutes / totalExits) : 0;
            
            // Format total time
            let totalTimeFormatted = '';
            if (totalSeconds > 0) {
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                
                if (hours > 0) {
                    totalTimeFormatted = `${hours} ุณุงุนุฉ ${minutes} ุฏูููุฉ ${seconds} ุซุงููุฉ`;
                } else if (minutes > 0) {
                    totalTimeFormatted = `${minutes} ุฏูููุฉ ${seconds} ุซุงููุฉ`;
                } else {
                    totalTimeFormatted = `${seconds} ุซุงููุฉ`;
                }
            } else {
                totalTimeFormatted = 'ูุง ููุฌุฏ';
            }
            
            const todayDate = new Date().toISOString().split('T')[0];
            const todayExits = logs.filter(log => log.date === todayDate).length;
            
            // Create a temporary div with the report content
            const reportDiv = document.createElement('div');
            reportDiv.style.cssText = `
                position: fixed;
                top: -9999px;
                left: -9999px;
                width: 800px;
                padding: 40px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                font-family: 'Cairo', sans-serif;
                direction: rtl;
                color: white;
            `;
            
            reportDiv.innerHTML = `
                <div style="background: white; border-radius: 20px; padding: 30px; color: #333; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                    <!-- Header -->
                    <div style="text-align: center; border-bottom: 3px solid #5D5CDE; padding-bottom: 20px; margin-bottom: 30px;">
                        <h1 style="color: #5D5CDE; font-size: 2.2em; margin-bottom: 10px; font-weight: bold;">๐ ุชูุฑูุฑ ูุชุงุจุนุฉ ุงูุทุงูุจ</h1>
                        <div style="color: #666; font-size: 1.1em;">ูุธุงู ูุชุงุจุนุฉ ุฏุฎูู ูุฎุฑูุฌ ุงูุทูุงุจ</div>
                    </div>
                    
                    <!-- Student Info -->
                    <div style="background: linear-gradient(45deg, #f8f9fa, #e9ecef); padding: 25px; border-radius: 15px; margin-bottom: 25px; border-right: 5px solid #5D5CDE;">
                        <h2 style="color: #5D5CDE; margin-bottom: 20px; font-size: 1.4em; font-weight: bold;">๐ ุจูุงูุงุช ุงูุทุงูุจ</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="display: flex; align-items: center;">
                                <strong style="color: #333; margin-left: 10px; min-width: 120px;">ุงุณู ุงูุทุงูุจ:</strong>
                                <span style="font-weight: 600; color: #5D5CDE;">${student.name}</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <strong style="color: #333; margin-left: 10px; min-width: 120px;">ุฑูู ุงูุทุงูุจ:</strong>
                                <span style="font-weight: 600; color: #5D5CDE;">${student.id}</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <strong style="color: #333; margin-left: 10px; min-width: 120px;">ุชุงุฑูุฎ ุงูุชูุฑูุฑ:</strong>
                                <span>${today}</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <strong style="color: #333; margin-left: 10px; min-width: 120px;">ููุช ุงูุฅูุดุงุก:</strong>
                                <span>${currentTime}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Statistics -->
                    <div style="margin-bottom: 25px;">
                        <h2 style="color: #5D5CDE; margin-bottom: 20px; font-size: 1.4em; border-bottom: 2px solid #eee; padding-bottom: 10px; font-weight: bold;">๐ ุงูุฅุญุตุงุฆูุงุช ุงูุนุงูุฉ</h2>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                            <div style="background: linear-gradient(45deg, #e3f2fd, #bbdefb); border: 2px solid #2196f3; border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #1976d2; margin-bottom: 5px;">${totalExits}</div>
                                <div style="color: #333; font-size: 0.9em; font-weight: 600;">ุฅุฌูุงูู ูุฑุงุช ุงูุฎุฑูุฌ</div>
                            </div>
                            <div style="background: linear-gradient(45deg, #fff3e0, #ffcc02); border: 2px solid #ff9800; border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #f57c00; margin-bottom: 5px;">${totalMinutes}</div>
                                <div style="color: #333; font-size: 0.9em; font-weight: 600;">ุฅุฌูุงูู ุงูุฏูุงุฆู</div>
                            </div>
                            <div style="background: linear-gradient(45deg, #e8f5e8, #c8e6c9); border: 2px solid #4caf50; border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #388e3c; margin-bottom: 5px;">${avgMinutes}</div>
                                <div style="color: #333; font-size: 0.9em; font-weight: 600;">ูุชูุณุท ููุช ุงูุฎุฑูุฌ (ุฏูููุฉ)</div>
                            </div>
                            <div style="background: linear-gradient(45deg, #fce4ec, #f8bbd9); border: 2px solid #e91e63; border-radius: 12px; padding: 20px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #c2185b; margin-bottom: 5px;">${todayExits}</div>
                                <div style="color: #333; font-size: 0.9em; font-weight: 600;">ุฎุฑูุฌ ุงูููู</div>
                            </div>
                        </div>
                        <div style="text-align: center; background: linear-gradient(45deg, #e3f2fd, #bbdefb); padding: 15px; border-radius: 10px; border: 2px solid #2196f3;">
                            <strong style="color: #333;">ุฅุฌูุงูู ุงูููุช ุงูููุถู ุฎุงุฑุฌ ุงููุตู: </strong>
                            <span style="color: #1976d2; font-weight: bold; font-size: 1.2em;">${totalTimeFormatted}</span>
                        </div>
                    </div>
                    
                    <!-- Recent History -->
                    <div style="margin-bottom: 25px;">
                        <h2 style="color: #5D5CDE; margin-bottom: 20px; font-size: 1.4em; border-bottom: 2px solid #eee; padding-bottom: 10px; font-weight: bold;">๐ ุขุฎุฑ ุณุฌูุงุช ุงูุฎุฑูุฌ ูุงูุนูุฏุฉ</h2>
                        <div style="background: #f8f9fa; border-radius: 10px; overflow: hidden; border: 1px solid #dee2e6;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #5D5CDE; color: white;">
                                        <th style="padding: 12px; text-align: center; font-weight: 600; border-bottom: 1px solid #ddd;">ุงูุชุงุฑูุฎ</th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600; border-bottom: 1px solid #ddd;">ุงูุฎุฑูุฌ</th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600; border-bottom: 1px solid #ddd;">ุงูุนูุฏุฉ</th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600; border-bottom: 1px solid #ddd;">ุงููุฏุฉ</th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600; border-bottom: 1px solid #ddd;">ุงูุญุงูุฉ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${logs.sort((a, b) => new Date(b.exitTime) - new Date(a.exitTime)).slice(0, 8).map((log, index) => {
                                        const exitTime = new Date(log.exitTime);
                                        const returnTime = log.returnTime ? new Date(log.returnTime) : null;
                                        
                                        let durationDisplay = '-';
                                        if (returnTime) {
                                            const durationSeconds = log.durationSeconds || Math.round((returnTime - exitTime) / 1000);
                                            const hours = Math.floor(durationSeconds / 3600);
                                            const minutes = Math.floor((durationSeconds % 3600) / 60);
                                            const seconds = durationSeconds % 60;
                                            
                                            if (hours > 0) {
                                                durationDisplay = `${hours}ุณ ${minutes}ุฏ ${seconds}ุซ`;
                                            } else if (minutes > 0) {
                                                durationDisplay = `${minutes}ุฏ ${seconds}ุซ`;
                                            } else {
                                                durationDisplay = `${seconds}ุซ`;
                                            }
                                        }
                                        
                                        const status = returnTime ? 'ููุชูู' : 'ุบูุฑ ููุชูู';
                                        const statusStyle = returnTime ? 
                                            'background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold;' : 
                                            'background: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold;';
                                        const rowStyle = index % 2 === 1 ? 'background: #f8f9fa;' : 'background: white;';
                                        
                                        return `
                                            <tr style="${rowStyle}">
                                                <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd; font-size: 0.9em;">${exitTime.toLocaleDateString('ar-SA')}</td>
                                                <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd; font-size: 0.9em;">${exitTime.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}</td>
                                                <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd; font-size: 0.9em;">${returnTime ? returnTime.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }) : '-'}</td>
                                                <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd; font-size: 0.9em; font-family: monospace;">${durationDisplay}</td>
                                                <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd;"><span style="${statusStyle}">${status}</span></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                            ${logs.length === 0 ? '<p style="text-align: center; padding: 20px; color: #666;">ูุง ุชูุฌุฏ ุณุฌูุงุช ูุชุงุญุฉ</p>' : ''}
                            ${logs.length > 8 ? `<p style="text-align: center; padding: 10px; color: #666; font-size: 0.9em;">... ู ${logs.length - 8} ุณุฌู ุฅุถุงูู</p>` : ''}
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee; color: #666;">
                        <div style="font-size: 1.1em; color: #5D5CDE; font-weight: bold; margin-bottom: 5px;">๐ซ ูุธุงู ูุชุงุจุนุฉ ุงูุทูุงุจ</div>
                        <div style="font-size: 0.9em;">ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุชููุงุฆูุงู ูู ${today} ุงูุณุงุนุฉ ${currentTime}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(reportDiv);
            
            try {
                // Use html2canvas to convert the div to canvas
                const canvas = await html2canvas(reportDiv, {
                    width: 800,
                    height: reportDiv.scrollHeight + 80,
                    scale: 2,
                    useCORS: true,
                    backgroundColor: null,
                    allowTaint: true,
                    removeContainer: true
                });
                
                // Convert canvas to blob
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ุชูุฑูุฑ_ุงูุทุงูุจ_${student.name}_${today.replace(/\//g, '-')}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showSuccessMessage('ุชู ุชุตุฏูุฑ ุงูุชูุฑูุฑ ูุตูุฑุฉ ุจูุฌุงุญ');
                }, 'image/png', 1.0);
                
            } catch (error) {
                console.error('Error generating image:', error);
                // Fallback: show message to user
                showFallbackImageExport();
            } finally {
                // Remove the temporary div
                document.body.removeChild(reportDiv);
            }
        }

        function showFallbackImageExport() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-md w-full">
                    <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-600">
                        <h3 class="text-lg font-bold">ุชุตุฏูุฑ ูุตูุฑุฉ</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="p-6">
                        <div class="text-center mb-4">
                            <i class="fas fa-info-circle text-blue-500 text-3xl mb-3"></i>
                            <p class="text-gray-700 dark:text-gray-300 mb-4">
                                ูุชุตุฏูุฑ ุงูุชูุฑูุฑ ูุตูุฑุฉุ ููุฑุฌู ุงุณุชุฎุฏุงู ุฎุงุตูุฉ ููุทุฉ ุงูุดุงุดุฉ ูู ูุชุตูุญู:
                            </p>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">ุทุฑููุฉ ุฃุฎุฐ ููุทุฉ ุดุงุดุฉ:</h4>
                            <ul class="text-sm space-y-1 text-gray-600 dark:text-gray-400">
                                <li>โข <strong>Windows:</strong> ุงุถุบุท Ctrl + Shift + S</li>
                                <li>โข <strong>Mac:</strong> ุงุถุบุท Cmd + Shift + 4</li>
                                <li>โข <strong>Chrome:</strong> F12 โ More tools โ Screenshot</li>
                            </ul>
                        </div>
                    </div>
                    <div class="p-4 border-t border-gray-200 dark:border-gray-600">
                        <button onclick="this.closest('.fixed').remove()" class="w-full bg-primary text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                            ูููุช
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Load html2canvas library
        function loadHtml2Canvas() {
            return new Promise((resolve, reject) => {
                if (window.html2canvas) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Load jsPDF library
        function loadJsPDF() {
            return new Promise((resolve, reject) => {
                if (window.jspdf) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Loading message functions
        let loadingMessageElement = null;

        function showLoadingMessage(message) {
            hideLoadingMessage(); // Remove any existing loading message
            
            loadingMessageElement = document.createElement('div');
            loadingMessageElement.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loadingMessageElement.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 flex items-center space-x-4 space-x-reverse">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                    <div class="text-lg font-medium">${message}</div>
                </div>
            `;
            document.body.appendChild(loadingMessageElement);
        }

        function hideLoadingMessage() {
            if (loadingMessageElement) {
                document.body.removeChild(loadingMessageElement);
                loadingMessageElement = null;
            }
        }

        function showFallbackPDFExport() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-md w-full">
                    <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-600">
                        <h3 class="text-lg font-bold">ุชุตุฏูุฑ PDF</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="p-6">
                        <div class="text-center mb-4">
                            <i class="fas fa-exclamation-triangle text-orange-500 text-3xl mb-3"></i>
                            <p class="text-gray-700 dark:text-gray-300 mb-4">
                                ูู ูุชููู ูู ุชุตุฏูุฑ ููู PDF ุชููุงุฆูุงู. ููุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ุฃู ุงุณุชุฎุฏุงู ุฅุญุฏู ุงูุทุฑู ุงูุจุฏููุฉ:
                            </p>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">ุทุฑู ุจุฏููุฉ:</h4>
                            <ul class="text-sm space-y-1 text-gray-600 dark:text-gray-400">
                                <li>โข ุงุณุชุฎุฏู ุชุตุฏูุฑ ูุตูุฑุฉ ุซู ุญูููุง ูู PDF</li>
                                <li>โข ุงุณุชุฎุฏู ูุดุงุฑูุฉ ูุงุชุณ ุงุจ ุซู ุงูุณุฎ ุงููุต</li>
                                <li>โข ุฃุนุฏ ุชุญููู ุงูุตูุญุฉ ูุญุงูู ูุฑุฉ ุฃุฎุฑู</li>
                            </ul>
                        </div>
                    </div>
                    <div class="p-4 border-t border-gray-200 dark:border-gray-600">
                        <button onclick="this.closest('.fixed').remove()" class="w-full bg-primary text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                            ูููุช
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            await initApp();
            setupAdditionalEventListeners();
            
            // Load html2canvas and jsPDF for reports
            try {
                await Promise.all([
                    loadHtml2Canvas(),
                    loadJsPDF()
                ]);
            } catch (error) {
                console.log('Some libraries not loaded, fallback will be used for export functions');
            }
        });
    </script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('./sw.js').catch(function(e){console.log('SW reg failed', e);});
    });
  }
</script>
</body>
</html>
